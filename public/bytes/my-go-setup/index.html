<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>My Go setup | Tadej&#39;s bits and bytes</title>
<meta name="keywords" content="code, go, testing, docker">
<meta name="description" content="In this post I&rsquo;ll describe what I use for writing, linting, formatting, shipping, &hellip; Go code. This is the first in a series of posts where I&rsquo;ll describe my setup in the three languages that I code in: Go (this post), Python and C&#43;&#43;.
This one will be the most boring one in the series - Go is the most &ldquo;batteries included&rdquo; language out of the bunch, so there&rsquo;s not much to say beyond &ldquo;I use the default thing that Go/standard library provides&rdquo;.">
<meta name="author" content="Tadej Svetina">
<link rel="canonical" href="http://localhost:1313/bytes/my-go-setup/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.ed7ae013d3fbb133271a47a6c21394e4cc418fd34d0346f5cdf36316bed96bfd.css" integrity="sha256-7XrgE9P7sTMnGkemwhOU5MxBj9NNA0b1zfNjFr7Za/0=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/bytes/my-go-setup/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.19/dist/katex.min.css" integrity="sha384-7lU0muIg/i1plk7MgygDUp3/bNRA65orrBub4/OSWHECgwEsY83HaS1x3bljA/XV" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.19/dist/katex.min.js" integrity="sha384-RdymN7NRJ+XoyeRY4185zXaxq9QWOOx3O7beyyrRK4KQZrPlCDQQpCu95FoCGPAE" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.19/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
    onload="renderMathInElement(document.body);"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false}
            ]
        });
    });
</script>
<meta property="og:url" content="http://localhost:1313/bytes/my-go-setup/">
  <meta property="og:site_name" content="Tadej&#39;s bits and bytes">
  <meta property="og:title" content="My Go setup">
  <meta property="og:description" content="In this post I’ll describe what I use for writing, linting, formatting, shipping, … Go code. This is the first in a series of posts where I’ll describe my setup in the three languages that I code in: Go (this post), Python and C&#43;&#43;.
This one will be the most boring one in the series - Go is the most “batteries included” language out of the bunch, so there’s not much to say beyond “I use the default thing that Go/standard library provides”.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="bytes">
    <meta property="article:published_time" content="2025-01-03T21:43:56+03:00">
    <meta property="article:modified_time" content="2025-01-03T21:43:56+03:00">
    <meta property="article:tag" content="Code">
    <meta property="article:tag" content="Go">
    <meta property="article:tag" content="Testing">
    <meta property="article:tag" content="Docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My Go setup">
<meta name="twitter:description" content="In this post I&rsquo;ll describe what I use for writing, linting, formatting, shipping, &hellip; Go code. This is the first in a series of posts where I&rsquo;ll describe my setup in the three languages that I code in: Go (this post), Python and C&#43;&#43;.
This one will be the most boring one in the series - Go is the most &ldquo;batteries included&rdquo; language out of the bunch, so there&rsquo;s not much to say beyond &ldquo;I use the default thing that Go/standard library provides&rdquo;.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Bytes",
      "item": "http://localhost:1313/bytes/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "My Go setup",
      "item": "http://localhost:1313/bytes/my-go-setup/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "My Go setup",
  "name": "My Go setup",
  "description": "In this post I\u0026rsquo;ll describe what I use for writing, linting, formatting, shipping, \u0026hellip; Go code. This is the first in a series of posts where I\u0026rsquo;ll describe my setup in the three languages that I code in: Go (this post), Python and C++.\nThis one will be the most boring one in the series - Go is the most \u0026ldquo;batteries included\u0026rdquo; language out of the bunch, so there\u0026rsquo;s not much to say beyond \u0026ldquo;I use the default thing that Go/standard library provides\u0026rdquo;.\n",
  "keywords": [
    "code", "go", "testing", "docker"
  ],
  "articleBody": "In this post I’ll describe what I use for writing, linting, formatting, shipping, … Go code. This is the first in a series of posts where I’ll describe my setup in the three languages that I code in: Go (this post), Python and C++.\nThis one will be the most boring one in the series - Go is the most “batteries included” language out of the bunch, so there’s not much to say beyond “I use the default thing that Go/standard library provides”.\nI code in VSCode, so my setup is geared towards it.\nEnvironment managament I’m lucky I don’t have to think about setting up an “environment” for Go at all - I just install the latest Go binary, navigate to the directory where I want to set up a project, and do\ngo mod init That’s it. The only potential downside is that this way I am bound to the latest Go version across all my projects - but given Go’s strong dedication to backward compatibility, this is not an issue.\nThis “guarantee” also contributes to the established practice in Go community of only supporting the two most recent minor versions of the language - as it is always safe to upgrade, there is no reason anyone would need support for an older version of the language.\nPackage management Here I can also relax and just use Go’s default package manager (modules). I don’t think anything else exists.\nUpdating all packages is easy:\ngo get -u I like to follow that up with go mod tidy to clean up go.sum.\nIDE integration (LSP, formatting) Language server features of Go are provided by gopls (ships with Go binary), and managed by the official Go VSCode extension. Everything works as it should - you can see object types, function signatures when hovering over code.\ngo fmt is used for formatting code—although I mostly call it with a keyboard shortcut in the IDE for the file I’m working on.\nDebugging I haven’t yet needed to use a debugger in Go - if I ever will, I will use delve.\nLinting I use golangci-lint - it’s a lint runner that runs a bunch of different linters, all specified in a single config file. Due to a large number of linters run, it takes a while to run (~20s). In VSCode I use it with the --fast flag, I only run the full version before committing and in CI.\nTesting Go standard library testing package is great! Amazing support for all kinds of tests and benchmarking. Although to be able to fully exploit its capabilities you need to learn a few tricks. For example, using t.Cleanup to clean up resources after a test.\nIf doing tests on a database, you might want to isolate tests from one another either by injecting a transaction that gets rolled back at the end of the test, or by re-creating database from a template for each test. Describing these techniques in details would require it own post - here’s a nice repo with examples and a video (in Russian) that go into much more detail.\nOh and, I use the testify library for assert statements. I really think it should be part of the standard library.\nI used to heavily rely on TestSuite from this library as well (I came to Go from Python, and using a test suite was as close to writing tests a-la pytest as I could get), but have since torn it out and replaced it with TestMain and a few judiciously placed global variables.\nHere’s an example test file that uses some of the things mentioned above:\npackage db_test import ( \"os\" \"testing\" \"github.com/stretchr/testify/assert\" \"myrepo/fakedb\" ) // Global DB connection. var dbConn *fakedb.Connection // setupUsersTable is a helper function that creates the 'users' table // and schedules it to be dropped after the test completes. func setupUsersTable(t *testing.T) { t.Helper() err := dbConn.Exec(\"CREATE TABLE users (id INT, name TEXT)\") if err != nil { t.Fatalf(\"failed to create table: %v\", err) } t.Cleanup(func() { _ = dbConn.Exec(\"DROP TABLE users\") }) } func TestMain(m *testing.M) { // Initialize and open the database connection. dbConn = fakedb.NewConnection(\"fakedb://localhost:5432\") if err := dbConn.Open(); err != nil { os.Exit(1) // If we can't open the DB, exit immediately. } // Run all tests. m.Run() // Close the connection, clean up resources. dbConn.Close() } func TestInsertUser(t *testing.T) { setupUsersTable(t) err := dbConn.Insert(\"users\", map[string]interface{}{ \"id\": 1, \"name\": \"Alice\", }) assert.NoError(t, err, \"Insert should succeed\") // Query the user row. rows, err := dbConn.Query(\"SELECT name FROM users WHERE id = 1\") assert.NoError(t, err, \"Query should succeed\") // Check that exactly one row is returned, and the data is correct. assert.Len(t, rows, 1) assert.Equal(t, \"Alice\", rows[0][\"name\"]) } Shipping Building code is as easy as runing\ngo build ./... I ship go binaries in docker containers. Since the binary is pretty much the only thing required for the application to run, I use the minimal distroless images to ship the binary.\nAnother thing when shipping is that the binary can be used on a different architecture than it was built on (for example, you build it on an amd64 PC, but will run it on a arm64 server). There are two things you can do here:\nuse emulation (e.g. QEMU) to build the image use cross-compilation Emulation usually results in really slow build times, so I avoid it if I can. Luckily, Go has pretty great support for cross-compilation out of the box - you just need to set GOARCH flag when compiling.\nHere’s how a minimal Dockerfile for building and shipping a Go binary might look like\nFROM --platform=$BUILDPLATFORM golang:1.23-alpine AS build ARG TARGETPLATFORM COPY go.sum go.mod main.go ./ RUN CGO_ENABLED=0 GOARCH=$(echo $TARGETPLATFORM | cut -d'/' -f2) GOOS=linux go build -o server . FROM gcr.io/distroless/static-debian11 AS base USER nonroot COPY --from=build --chown=nonroot:nonroot /app/server /server ENTRYPOINT [\"/server\"] Docker requires you to specify the target platform as linux/arm64 or linux/amd64, while Go omits the linux/ prefix, which is why the use of cut is needed.\n",
  "wordCount" : "1002",
  "inLanguage": "en",
  "datePublished": "2025-01-03T21:43:56+03:00",
  "dateModified": "2025-01-03T21:43:56+03:00",
  "author":{
    "@type": "Person",
    "name": "Tadej Svetina"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/bytes/my-go-setup/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Tadej's bits and bytes",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Tadej&#39;s bits and bytes (Alt + H)">Tadej&#39;s bits and bytes</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/bits" title="Bits">
                    <span>Bits</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/bytes" title="Bytes">
                    <span>Bytes</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/bytes/">Bytes</a></div>
    <h1 class="post-title entry-hint-parent">
      My Go setup
    </h1>
    <div class="post-meta"><span title='2025-01-03 21:43:56 +0300 MSK'>January 3, 2025</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;Tadej Svetina

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#environment-managament" aria-label="Environment managament">Environment managament</a></li>
                <li>
                    <a href="#package-management" aria-label="Package management">Package management</a></li>
                <li>
                    <a href="#ide-integration-lsp-formatting" aria-label="IDE integration (LSP, formatting)">IDE integration (LSP, formatting)</a></li>
                <li>
                    <a href="#debugging" aria-label="Debugging">Debugging</a></li>
                <li>
                    <a href="#linting" aria-label="Linting">Linting</a></li>
                <li>
                    <a href="#testing" aria-label="Testing">Testing</a></li>
                <li>
                    <a href="#shipping" aria-label="Shipping">Shipping</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>In this post I&rsquo;ll describe what I use for writing, linting, formatting, shipping, &hellip; <strong>Go code</strong>. This is the first in a series of posts where I&rsquo;ll describe my setup in the three languages that I code in: Go (this post), Python and C++.</p>
<p>This one will be the most boring one in the series - Go is the most &ldquo;batteries included&rdquo; language out of the bunch, so there&rsquo;s not much to say beyond &ldquo;I use the default thing that Go/standard library provides&rdquo;.</p>
<p>I code in VSCode, so my setup is geared towards it.</p>
<h2 id="environment-managament">Environment managament<a hidden class="anchor" aria-hidden="true" href="#environment-managament">#</a></h2>
<p>I&rsquo;m lucky I don&rsquo;t have to think about setting up an &ldquo;environment&rdquo; for Go at all - I just <a href="https://go.dev/doc/install">install</a> the latest Go binary, navigate to the directory where I want to set up a project, and do</p>
<pre tabindex="0"><code>go mod init &lt;project_name&gt;
</code></pre><p>That&rsquo;s it. The only potential downside is that this way I am bound to the latest Go version across all my projects - but given Go&rsquo;s strong dedication to <a href="https://go.dev/blog/compat">backward compatibility</a>, this is not an issue.</p>
<p>This &ldquo;guarantee&rdquo; also contributes to the established practice in Go community of only supporting the two most recent minor versions of the language - as it is always safe to upgrade, there is no reason anyone would need support for an older version of the language.</p>
<h2 id="package-management">Package management<a hidden class="anchor" aria-hidden="true" href="#package-management">#</a></h2>
<p>Here I can also relax and just use Go&rsquo;s default package manager (<a href="https://go.dev/blog/using-go-modules">modules</a>). I don&rsquo;t think anything else exists.</p>
<p>Updating all packages is easy:</p>
<pre tabindex="0"><code>go get -u
</code></pre><p>I like to follow that up with <code>go mod tidy</code> to clean up <code>go.sum</code>.</p>
<h2 id="ide-integration-lsp-formatting">IDE integration (LSP, formatting)<a hidden class="anchor" aria-hidden="true" href="#ide-integration-lsp-formatting">#</a></h2>
<p>Language server features of Go are provided by <code>gopls</code> (ships with Go binary), and managed by the official Go VSCode extension. Everything works as it should - you can see object types, function signatures when hovering over code.</p>
<p><code>go fmt</code> is used for formatting code—although I mostly call it with a keyboard shortcut in the IDE for the file I’m working on.</p>
<h2 id="debugging">Debugging<a hidden class="anchor" aria-hidden="true" href="#debugging">#</a></h2>
<p>I haven&rsquo;t yet needed to use a debugger in Go - if I ever will, I will use <a href="https://github.com/go-delve/delve">delve</a>.</p>
<h2 id="linting">Linting<a hidden class="anchor" aria-hidden="true" href="#linting">#</a></h2>
<p>I use <a href="https://github.com/golangci/golangci-lint">golangci-lint</a> - it&rsquo;s a lint runner that runs a bunch of different linters, all specified in a single config file. Due to a large number of linters run, it takes a while to run (~20s). In VSCode I use it with the <a href="https://golangci-lint.run/welcome/integrations/#go-for-visual-studio-code"><code>--fast</code></a> flag, I only run the full version before committing and in CI.</p>
<h2 id="testing">Testing<a hidden class="anchor" aria-hidden="true" href="#testing">#</a></h2>
<p>Go standard library <a href="https://pkg.go.dev/testing">testing</a> package is great! Amazing support for all kinds of tests and benchmarking. Although to be able to fully exploit its capabilities you need to <a href="https://www.youtube.com/watch?v=8hQG7QlcLBk">learn a few tricks</a>. For example, using <code>t.Cleanup</code> to clean up resources after a test.</p>
<p>If doing tests on a database, you might want to isolate tests from one another either by injecting a transaction that gets rolled back at the end of the test, or by re-creating database from a template for each test. Describing these techniques in details would require it own post - here&rsquo;s a nice <a href="https://github.com/xorcare/testing-go-code-with-postgres">repo with examples</a> and <a href="https://www.youtube.com/watch?v=NMYBSyvoUzE">a video</a> (in Russian) that go into much more detail.</p>
<p>Oh and, I use the <a href="https://github.com/stretchr/testify">testify</a> library for <code>assert</code> statements. I really think it should be part of the standard library.</p>
<p>I used to heavily rely on <code>TestSuite</code> from this library as well (I came to Go from Python, and using a test suite was as close to writing tests a-la <code>pytest</code> as I could get), but have since torn it out and replaced it with <a href="https://pkg.go.dev/testing#hdr-Main"><code>TestMain</code></a> and a few judiciously placed global variables.</p>
<p>Here&rsquo;s an example test file that uses some of the things mentioned above:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">db_test</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;myrepo/fakedb&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Global DB connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">dbConn</span> <span class="o">*</span><span class="nx">fakedb</span><span class="p">.</span><span class="nx">Connection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// setupUsersTable is a helper function that creates the &#39;users&#39; table
</span></span></span><span class="line"><span class="cl"><span class="c1">// and schedules it to be dropped after the test completes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">setupUsersTable</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span><span class="p">.</span><span class="nf">Helper</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dbConn</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;CREATE TABLE users (id INT, name TEXT)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;failed to create table: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">t</span><span class="p">.</span><span class="nf">Cleanup</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_</span> <span class="p">=</span> <span class="nx">dbConn</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;DROP TABLE users&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestMain</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Initialize and open the database connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dbConn</span> <span class="p">=</span> <span class="nx">fakedb</span><span class="p">.</span><span class="nf">NewConnection</span><span class="p">(</span><span class="s">&#34;fakedb://localhost:5432&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dbConn</span><span class="p">.</span><span class="nf">Open</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// If we can&#39;t open the DB, exit immediately.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Run all tests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Close the connection, clean up resources.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dbConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestInsertUser</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setupUsersTable</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dbConn</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="s">&#34;users&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;id&#34;</span><span class="p">:</span>   <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;Alice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Insert should succeed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Query the user row.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dbConn</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT name FROM users WHERE id = 1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="s">&#34;Query should succeed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Check that exactly one row is returned, and the data is correct.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">assert</span><span class="p">.</span><span class="nf">Len</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s">&#34;Alice&#34;</span><span class="p">,</span> <span class="nx">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#34;name&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="shipping">Shipping<a hidden class="anchor" aria-hidden="true" href="#shipping">#</a></h2>
<p>Building code is as easy as runing</p>
<pre tabindex="0"><code>go build ./...
</code></pre><p>I ship go binaries in docker containers. Since the binary is pretty much the only thing required for the application to run, I use the minimal <a href="https://github.com/GoogleContainerTools/distroless">distroless</a> images to ship the binary.</p>
<p>Another thing when shipping is that the binary can be used on a different architecture than it was built on (for example, you build it on an <code>amd64</code> PC, but will run it on a <code>arm64</code> server). There are two things you can do here:</p>
<ul>
<li>use emulation (e.g. QEMU) to build the image</li>
<li>use cross-compilation</li>
</ul>
<p>Emulation usually results in really slow build times, so I avoid it if I can. Luckily, Go has pretty great support for cross-compilation out of the box - you just need to set <code>GOARCH</code> flag when compiling.</p>
<p>Here&rsquo;s how a minimal <code>Dockerfile</code> for building and shipping a Go binary might look like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="k">FROM</span><span class="s"> --platform=$BUILDPLATFORM golang:1.23-alpine AS build</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ARG</span> TARGETPLATFORM<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> go.sum go.mod main.go ./<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> <span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">0</span> <span class="nv">GOARCH</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$TARGETPLATFORM</span> <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f2<span class="k">)</span> <span class="nv">GOOS</span><span class="o">=</span>linux go build -o server .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> gcr.io/distroless/static-debian11 AS base</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">USER</span><span class="s"> nonroot</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>build --chown<span class="o">=</span>nonroot:nonroot /app/server /server<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&#34;/server&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>Docker requires you to specify the target platform as <code>linux/arm64</code> or <code>linux/amd64</code>, while Go omits the <code>linux/</code> prefix, which is why the use of <code>cut</code> is needed.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/code/">Code</a></li>
      <li><a href="http://localhost:1313/tags/go/">Go</a></li>
      <li><a href="http://localhost:1313/tags/testing/">Testing</a></li>
      <li><a href="http://localhost:1313/tags/docker/">Docker</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/bits/aoc-2024-day-9/">
    <span class="title">« Prev</span>
    <br>
    <span>AOC 2024 Day 9: A clever use of heaps</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share My Go setup on x"
            href="https://x.com/intent/tweet/?text=My%20Go%20setup&amp;url=http%3a%2f%2flocalhost%3a1313%2fbytes%2fmy-go-setup%2f&amp;hashtags=code%2cgo%2ctesting%2cdocker">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share My Go setup on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fbytes%2fmy-go-setup%2f&amp;title=My%20Go%20setup&amp;summary=My%20Go%20setup&amp;source=http%3a%2f%2flocalhost%3a1313%2fbytes%2fmy-go-setup%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share My Go setup on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fbytes%2fmy-go-setup%2f&title=My%20Go%20setup">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share My Go setup on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fbytes%2fmy-go-setup%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share My Go setup on telegram"
            href="https://telegram.me/share/url?text=My%20Go%20setup&amp;url=http%3a%2f%2flocalhost%3a1313%2fbytes%2fmy-go-setup%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Tadej&#39;s bits and bytes</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
